{% extends 'base.html' %}

{% block content %}
<div class="flex justify-center items-center min-h-[85vh] py-10">
    <div class="w-full max-w-2xl bg-bg rounded-neu shadow-neu-out p-10">
        <h2 class="text-3xl font-bold text-center mb-8 text-primary">Post a New Job</h2>

        <form id="post-job-form" class="space-y-6">
            <div>
                <label class="block text-sm font-bold mb-2 ml-1 text-primary">Job Title</label>
                <input type="text" id="title" required
                    class="w-full px-4 py-3 bg-bg rounded-neu shadow-neu-in outline-none focus:ring-2 focus:ring-accent/50 text-text transition placeholder-gray-400"
                    placeholder="e.g. Senior React Developer">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold mb-2 ml-1 text-primary">Job Type</label>
                    <select id="job_type"
                        class="w-full px-4 py-3 bg-bg rounded-neu shadow-neu-out outline-none focus:ring-2 focus:ring-accent/50 text-text transition appearance-none">
                        <option value="full_time">Full Time</option>
                        <option value="part_time">Part Time</option>
                        <option value="contract">Contract</option>
                        <option value="freelance">Freelance</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2 ml-1 text-primary">Experience Level</label>
                    <select id="experience_level"
                        class="w-full px-4 py-3 bg-bg rounded-neu shadow-neu-out outline-none focus:ring-2 focus:ring-accent/50 text-text transition appearance-none">
                        <option value="junior">Junior</option>
                        <option value="mid">Mid-Level</option>
                        <option value="senior">Senior</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold mb-2 ml-1 text-primary">Hourly Rate ($)</label>
                    <input type="number" id="pay_per_hour" required
                        class="w-full px-4 py-3 bg-bg rounded-neu shadow-neu-in outline-none focus:ring-2 focus:ring-accent/50 text-text transition placeholder-gray-400"
                        placeholder="e.g. 60">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2 ml-1 text-primary">Location</label>
                    <input type="text" id="location"
                        class="w-full px-4 py-3 bg-bg rounded-neu shadow-neu-in outline-none focus:ring-2 focus:ring-accent/50 text-text transition placeholder-gray-400"
                        placeholder="e.g. Remote, New York">
                </div>
            </div>

            <div>
                <label class="block text-sm font-bold mb-2 ml-1 text-primary">Description</label>
                <textarea id="description" rows="5" required
                    class="w-full px-4 py-3 bg-bg rounded-neu shadow-neu-in outline-none focus:ring-2 focus:ring-accent/50 text-text transition placeholder-gray-400"
                    placeholder="Job responsibilities, requirements..."></textarea>
            </div>

            <div>
                <label class="block text-sm font-bold mb-2 ml-1 text-primary">Required Skills (Comma separated)</label>
                <input type="text" id="required_skills"
                    class="w-full px-4 py-3 bg-bg rounded-neu shadow-neu-in outline-none focus:ring-2 focus:ring-accent/50 text-text transition placeholder-gray-400"
                    placeholder="Python, Django, AWS">
            </div>

            <div>
                <label class="block text-sm font-bold mb-2 ml-1 text-primary">Tech Stack (Comma separated)</label>
                <input type="text" id="tech_stack"
                    class="w-full px-4 py-3 bg-bg rounded-neu shadow-neu-in outline-none focus:ring-2 focus:ring-accent/50 text-text transition placeholder-gray-400"
                    placeholder="Docker, Kubernetes, Redis">
            </div>

            <button type="submit" id="submit-btn"
                class="w-full py-3 bg-accent text-white font-bold rounded-neu shadow-neu-btn active:shadow-neu-in transform active:translate-y-1 transition flex justify-center items-center gap-2">
                Post Job
            </button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (!window.checkSession()) return;
        const user = window.getUser();
        if (user && user.user_type !== 'recruiter') {
            window.showToast("Only recruiters can post jobs.", 'error');
            setTimeout(() => window.location.href = '/dashboard/', 2000);
        }
    });

    document.getElementById('post-job-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="animate-spin">â†»</span> Posting...';

        const token = window.getAccessToken();

        try {
            const data = {
                title: document.getElementById('title').value,
                job_type: document.getElementById('job_type').value,
                experience_level: document.getElementById('experience_level').value,
                pay_per_hour: document.getElementById('pay_per_hour').value,
                location: document.getElementById('location').value,
                description: document.getElementById('description').value,
                required_skills: document.getElementById('required_skills').value.split(',').map(s => s.trim()).filter(Boolean),
                tech_stack: document.getElementById('tech_stack').value.split(',').map(s => s.trim()).filter(Boolean)
            };

            const res = await fetch('/api/jobs/', { // Assuming POST /api/jobs/ creates job
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                window.showToast("Job posted successfully!", 'success');
                setTimeout(() => window.location.href = '/dashboard/', 1500);
            } else {
                const err = await res.json();
                window.showToast("Failed to post job. " + (err.detail || JSON.stringify(err)), 'error');
            }
        } catch (e) {
            console.error(e);
            window.showToast("An error occurred.", 'error');
        } finally {
            btn.disabled = false;
            btn.innerText = 'Post Job';
        }
    });
</script>
{% endblock %}